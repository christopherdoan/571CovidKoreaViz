<!DOCTYPE html>
<html lang="en">
    <style>
        .tooltip {
            background: rgba(255, 255, 255, 0.92);
            position: absolute;
            height: auto;
            z-index:9999;
            padding:5px;
            border: 1px solid #ddd;
            padding: 5px 15px 5px 15px;
            font-family: arial, sans-serif;
            -webkit-box-shadow: 2px 2px 2px rgba(0, 0, 0, 0.1);
            -moz-box-shadow: 2px 2px 2px rgba(0, 0, 0, 0.1);
            box-shadow: 2px 2px 2px rgba(0, 0, 0, 0.1);
            }

        .radio-toolbar {
            margin: 10px;
        }

        .radio-toolbar input[type="radio"] {
            opacity: 0;
            position: fixed;
            width: 0;
            }

        .radio-toolbar label {
                display: inline-block;
                background-color: #ddd;
                padding: 10px 20px;
                font-family: sans-serif, Arial;
                font-size: 16px;
                border: 2px solid #444;
                border-radius: 4px;
        }

        .radio-toolbar label:hover {
            background-color: #dfd;
        }

        .radio-toolbar input[type="radio"]:focus + label {
                border: 2px dashed #444;
        }

        .radio-toolbar input[type="radio"]:checked + label {
                background-color: #bfb;
                border-color: #4c4;
        }

        .total {
                display: inline-block;
                background-color: #ddd;
                padding: 10px 20px;
                font-family: sans-serif, Arial;
                font-size: 16px;
                border: 2px solid #444;
                border-radius: 4px;
        }

        .total:hover{
            background-color: #dfd;
        }

    </style>
	<head>
		<meta charset="utf-8">
		<title>Word Cloud</title>
		<script type="text/javascript" src="https://d3js.org/d3.v6.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3-cloud/1.2.5/d3.layout.cloud.js"></script>
        <script src="https://unpkg.com/d3-simple-slider"></script>

		
	</head>
    
	<body>
    <svg width = 1000 height = 50 id = title></svg>
    <div id= "template"><svg width = 1000 height = 600 id = cloud></svg></div>
    <svg width = 1000 height = 80 id = slide></svg>
    <div class="radio-toolbar">
        <input type="radio" name="states" value="set1" id = "1" checked = "checked">
        <label for = "1">
            Word Cloud
        </label>
        <input type="radio" name="states" value="set2" id = "2">
        <label for = "2">
            Lollipop Chart
        </label>
        <button class = "total">Show total</button>
    </div>
     

    <svg width = 80 height = 80 id = slide2></svg>
    <!-- <button type="button">Click Me!</button> -->
		<script type="text/javascript">
            

			//Width and height
			var width = 1000;
			var height = 600;
            var padding = 40;

            var flag = 1;

            //Create SVG element
            var svg = d3.select("svg#cloud");
						// .append("svg")
						// .attr("width", width)
						// .attr("height", height);
            svg.append('g')

            var svg2 = d3.select("svg#slide");

            var svg3 = d3.select("svg#title");

						// .append("svg")
						// .attr("width", width)
						// .attr("height", 80);
            
            svg3.append('text')
                .text("Search Keyword Trends Cloud (Total)")
                .attr("x", (width / 2))             
                .attr("y", 35 )
                .attr("text-anchor", "middle")  
                .style("font-size", "36px") 
                .style("text-decoration", "underline");

            var Tooltip = d3.select("#template")
                .append("div")
                .style("opacity", 0)
                .attr("class", "tooltip")
                .style("background-color", "white")
                .style("border", "solid")
                .style("border-width", "2px")
                .style("border-radius", "5px")
                .style("padding", "5px");
    
            
            var months = ["November", "December", "January", "February", "March", "April", "May", "June", "July"]
            var monthsObj = {"November" : 1, "December": 2, "January": 3, "February": 4, "March": 5, 
                            "April": 6, "May": 7, "June": 8, "July": 9}

            var dataTime = d3.range(0, 9).map(function(d) {
                return new Date(2019,10 + d,3);
            });

            var november = new Date(2019,10,3);
            var december = new Date(2019,11,3,23);
            var january = new Date(2020,0,3,23);
            var february = new Date(2020,1,3,23);
            var march = new Date(2020,2,5,23);
            var april = new Date(2020,3,6);
            var may = new Date(2020,4,7);
            var june = new Date(2020,5,7);
            var july = new Date(2020,6,8);
            var monthList = [november, december, january, february, march, april, may, june, july];

            var promises = [d3.csv("data/wordcounts_total.csv"),
                d3.csv("data/wordcounts_November.csv"),
                d3.csv("data/wordcounts_December.csv"),
                d3.csv("data/wordcounts_January.csv"),
                d3.csv("data/wordcounts_February.csv"),
                d3.csv("data/wordcounts_March.csv"),
                d3.csv("data/wordcounts_April.csv"),
                d3.csv("data/wordcounts_May.csv"),
                d3.csv("data/wordcounts_June.csv"),
                d3.csv("data/wordcounts_July.csv"),];
            var myDataPromises = Promise.all(promises);

            // var ticker = function(d){return d + 'GB';};

            // console.log(dataTime[1])
            myDataPromises.then((allData) =>{

                var slider2 = d3
                    .sliderHorizontal()
                    .min(0)
                    .max(1)
                    .step(1000 * 60 * 60 * 24 * 31)
                    .width(width-(padding*2))
                    .tickFormat(d3.timeFormat('%m-%Y'))
                    .tickValues(dataTime)
                    .default(new Date(2019,10,3))

                var slider = d3
                    .sliderHorizontal()
                    .min(d3.min(dataTime))
                    .max(d3.max(dataTime))
                    .step(1000 * 60 * 60 * 24 * 31)
                    .width(width-(padding*2))
                    .tickFormat(d3.timeFormat('%m-%Y'))
                    .tickValues(dataTime)
                    .default(new Date(2019,10,3))
                    .on('onchange', (val) => {
                        flag = 0;
                        svg.select('g').interrupt();
                        svg.select('g').remove();
                        svg.append('g');
                        var index = 0;
                        for(const month of monthList){
                            if (val.getTime() === month.getTime()){
                                drawCloud(months[index]);
                            }
                            index = index + 1;
                        }
                        });
                

                var totalButton = d3.selectAll("button");
                totalButton.on("click", function(d){
                    flag = 1;
                    svg.select('g').interrupt();
                    svg.select('g').remove();
                    svg.append('g');
                    drawCloud("total");

                });
                const buttons = d3.selectAll('input');
                var type = "set1";
                buttons.on('change', function(d) {
                    type = this.value;
                    svg.selectAll("line").remove();
                    svg.selectAll("circle").remove();
                    svg.select('g').remove();
                    svg.append('g');

                    if (flag === 1){
                        drawCloud("total")
                    }
                    else{
                        var val = slider.value()
                        var index = 0;
                        for(const month of monthList){
                                if (val.getTime() === month.getTime()){
                                    drawCloud(months[index]);
                                }
                                index = index + 1;
                            }
                    }
                });

                var cloudSlider = svg2.append('g')
                    .attr('transform', 'translate(30,30)');
                
                cloudSlider.call(slider)

                drawCloud("total");

                var indWords = svg.selectAll("g");
                indWords.on("click", function(d){
                    console.log("here");
                });

                var indLines = svg.selectAll('g');
                console.log(indLines)
                indLines.on("click", function(d){
                    console.log("here");
                });

                // Initialize slider
                // var slider = d3.slider().min(0).max(10).ticks(10).showRange(true).value(0);
                // Render the slider in the div
                function drawCloud(month){  
                    
                    var fill = d3.scaleOrdinal(d3.schemeCategory10);

                    
                        var typeTitle = "";
                        var filterTitle = month;
                        var counts; 
                        if (month === "total"){
                            counts = allData[0];
                        }
                        else{
                            counts = allData[monthsObj[month]];
                        }
                        if (type === "set1"){
                            typeTitle = "Word Cloud";
                            var width = 1000;
                            var height = 600;
                            svg.select('g').interrupt();
                        // d3.select('svg#cloud').select('g').selectAll('text').transition().style("font-size", "1px");
                            svg.select('g').remove();
                            svg.append('g');
                            var countMax = Math.sqrt(Math.max.apply(Math, counts.map(function(o) { return o.counts; })));
                            var countMin = Math.sqrt(Math.min.apply(Math, counts.map(function(o) { return o.counts; })));
                            var wordScale = d3.scaleLinear()
                                .domain([countMin, countMax])
                                .range([15,115]);
                            var layout = d3.layout.cloud()
                                .size([width, height])
                                .words(counts)
                                .text((d) => d.word)
                                .fontSize(function(d){
                                    // console.log(wordScale(Math.sqrt(d.counts)));
                                    return wordScale(Math.sqrt(d.counts));
                                })
                                .on("end", draw);
                            

                            layout.start();


                            function getCount(word,struct){
                                var i;
                                var returnCount = 0;
                                for (i = 0; i < struct.length; i++){
                                    if (word === struct[i].word){
                                        returnCount = struct[i].counts
                                    }
                                }
                                return returnCount;
                            }
                            function draw(words) {
                                // console.log(words);
                            svg.select("g")
                                .attr("transform", "translate(" + layout.size()[0] / 2 + "," + layout.size()[1] / 2  + ")")
                                .selectAll("text")
                                .data(words)
                                .enter()
                                .append("text")
                                .on("mousemove", mousemove)                            
                                .on('mouseover', function(d){
                                    d3.select(this).transition().style("font-size", (d) => (1.2*d.size) + "px");
                                    mouseover(this);
                                })
                                .on('mouseout', function(d){
                                    d3.select(this).transition().style("font-size", (d) => d.size + "px");
                                    mouseout(this);
                                })
                                .on('click', function(d){
                                    getCount(d3.select(this).data()[0].word,counts);
                                })
                                // .on('mouseover', function(d){
                                //     var tempData = d3.select(this);
                                //     console.log("this")
                                // })
                                .transition()
                                .text((d) => d.text)
                                .style("font-size", (d) => d.size + "px")
                                .style("font-family", (d) => d.font)
                                .style("fill", (d, i) => fill(i))
                                .attr("text-anchor", "middle")
                                .attr("transform", (d) => "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")");
                        }
                        svg3.select("text").transition().text("Search Keyword Trends " + typeTitle);
                    }
                    else if (type === "set2"){
                        typeTitle = "Lollipop Chart";
                        var margin = {top: 10, right: 30, bottom: 40, left: 90};
                        var width = 1000- margin.left - margin.right;
                        var height = 600- margin.top - margin.bottom;
                        svg.selectAll('g').remove();
                        svg.selectAll("line").remove();
                        svg.selectAll("circle").remove();
                        var x = d3.scaleLinear()
                        .domain([0,
                                Math.max.apply(Math, counts.map(function(o) { return o.counts; }))])
                        .range([ margin.left, width]);
                        svg.append("g")
                            .attr("transform", "translate(0," + height + ")")
                            .call(d3.axisBottom(x))
                            .selectAll("text")
                            .style("font-size", '16px')
                            .attr("transform", "translate(-10,0)rotate(-45)")
                            .style("text-anchor", "end");

                        // Y axis
                        var y = d3.scaleBand()
                            .domain(counts.map(function(d) { console.log(d.word); return d.word; }))
                            .range([ 0, height ])
                            .padding(1)
                            ;

                        svg.append("g")
                        .attr("transform", "translate(" + margin.left + ",0)")
                        .call(d3.axisLeft(y))
                        .style("font-size", '14px');

                        // Lines
                        svg.selectAll("myline")
                        .data(counts)
                        .enter()
                        .append("line")
                            .attr("x1",x(0))
                            .attr("x2", x(0))
                            .attr("y1", function(d) { return y(d.word); })
                            .attr("y2", function(d) { return y(d.word); })
                            .attr("stroke-width", 1)
                            .transition()
                            .duration(1000)
                            .attr("x1", function(d) { return x(d.counts); })
                            .attr("x2", x(0))
                            .attr("y1", function(d) { return y(d.word); })
                            .attr("y2", function(d) { return y(d.word); })
                            .attr("stroke", "grey")

                        // Circles
                        svg.selectAll("mycircle")
                        .data(counts)
                        .enter()
                        .append("circle")
                            .attr("cx", x(0))
                            .attr("cy", function(d) { return y(d.word); })
                            .on("mouseout", function(d){
                                d3.select(this).transition().attr("r", 4);
                                mouseout(this);
                            })
                            .on("mousemove", mousemove)
                            .on("mouseover", function(d){
                                d3.select(this).transition().attr("r", 6);
                                mouseover(this);
                            })
                            .transition()
                            .duration(1000)
                            .attr("cx", function(d) { return x(d.counts); })
                            .attr("cy", function(d) { return y(d.word); })
                            .attr("r", "4")
                            .style("fill", "#69b3a2")
                            .attr("stroke", "black");
                            
                    }

                    svg3.select("text").transition().text("Search Keyword Trends " + typeTitle + " (" +month+")");
                    
                }

            
                function mouseover(d){
                // Highlight hovered province
                // d3.select(this).style('transition', 'opacity 0.2s stroke-width 0s');
                Tooltip
                    .style("opacity", 1);
                }

                function mouseout(d){
                // Reset province color
                Tooltip
                    .style("opacity", 0);
                }

                function mousemove(d, e){
                console.log(d);
                console.log(e);
                Tooltip
                    .html(`Volume (converted): ${e.counts}`)
                    .style("left", (d.pageX+5) + "px")
                    .style("top", (d.pageY+5) + "px")

                // Tooltip.
                //   style("left", (d.pageX-parseFloat(Tooltip.style("width").split(".")[0])/2)+"px");
                }
            });

        
            
		</script>
       
	</body>
     
</html>